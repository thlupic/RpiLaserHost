<!DOCTYPE html>
<html>
  <head>
      <!-- BASICS -->
      <title>Stopwatch</title>
      <meta charset="utf-8"/>
      <link rel="stylesheet" href="css/main.css">
      <!-- SCRIPTS -->
      <script src="Scripts/jquery.min.js"></script>
      <script src="Scripts/jquery-ui.js"></script>
      <link rel="stylesheet" href="css/jquery-ui.css" type="text/css" media="all" />
      <!--Reference the SignalR library. -->
      <script src="Scripts/jquery.signalR-2.2.1.min.js"></script>
      <!--Reference the autogenerated SignalR hub script. -->
      <script src="http://192.168.1.29:9000/signalr/hubs"></script>
  </head>
  <body>

  <div class="counter__wrapper">
    <span id="sw_h">00</span>
      <strong>:</strong>
    <span id="sw_m">00</span>
      <strong>:</strong>
    <span id="sw_s">00</span>
      <strong>:</strong>
    <span id="sw_ms">00</span>
  </div>

  <table cellspacing="0" class="results" id="tableResults" border='1'>
      <thead>
          <tr class="label">
              <th>Name</th>
              <th>Time</th>
          </tr>
      </thead>
      <tbody id="results">
      </tbody>
  </table>

  <div class="sponsors">
    <img src="img/hep.png" alt="HEP">
    <img src="img/pf_logo.png" alt="PF">
  </div>

  <script>

      function tableFill() {
          jQuery.ajaxSetup({ async: false });
          var data = $.get("http://192.168.1.29:9000/api/results");
          jQuery.ajaxSetup({ async: true });

          var jsonString = data.responseJSON;

          var jsonData = JSON.parse(jsonString);

          $("#results").html("");

          var trHtml = '';

          for (var i = 0; i < jsonData.length; i++) {
              trHtml += '<tr><th>' + jsonData[i].Name + '</th><th>' + jsonData[i].Time + '</th></tr>';
          };

          $('#results').append(trHtml);

        
      }

      $(document)
          .ready(tableFill());

      $(document)
          .ready(function () {
              var penalty = 20;
              var totalPenaltyTime = 0;
              (function($) {
                  $.extend({
                      APP: {
                          formatTimer: function(a) {
                              if (a < 10) {
                                  a = '0' + a;
                              }
                              return a;
                          },

                          addPenalty: function() {
                              totalPenaltyTime = totalPenaltyTime+penalty;
                          },

                          startTimer: function(dir) {
                              totalPenaltyTime = 0;

                              // save type
                              $.APP.dir = dir;

                              // get current date
                              $.APP.d1 = new Date();

                              switch ($.APP.state) {

                              case 'pause':

                                  // resume timer
                                  // get current timestamp (for calculations) and
                                  // substract time difference between pause and now
                                  $.APP.t1 = $.APP.d1.getTime() - $.APP.td;

                                  break;

                              default:

                                  // get current timestamp (for calculations)
                                  $.APP.t1 = $.APP.d1.getTime();

                                  // if countdown add ms based on seconds in textfield
                                  if ($.APP.dir === 'cd') {
                                      $.APP.t1 += parseInt($('#cd_seconds').val()) * 1000;
                                  }

                                  break;

                              }

                              // reset state
                              $.APP.state = 'alive';

                              // start loop
                              $.APP.loopTimer();
                          },

                          pauseTimer: function() {

                              // save timestamp of pause
                              $.APP.dp = new Date();
                              $.APP.tp = $.APP.dp.getTime();

                              // save elapsed time (until pause)
                              $.APP.td = $.APP.tp - $.APP.t1;

                              // change button value
                              $('#' + $.APP.dir + '_start').val('Resume');

                              // set state
                              $.APP.state = 'pause';

                          },

                          stopTimer: function() {
                              // change button value
                              $('#' + $.APP.dir + '_start').val('Restart');

                              // set state
                              $.APP.state = 'stop';
                          },

                          resetTimer: function() {
                              // reset display
                              $('#' + $.APP.dir + '_ms,#' + $.APP.dir + '_s,#' + $.APP.dir + '_m,#' + $.APP.dir + '_h')
                                  .html('00');

                              // change button value
                              $('#' + $.APP.dir + '_start').val('Start');

                              // set state
                              $.APP.state = 'reset';
                          },

                          endTimer: function(callback) {
                              // change button value
                              $('#' + $.APP.dir + '_start').val('Restart');

                              // set state
                              $.APP.state = 'end';

                              // invoke callback
                              if (typeof callback === 'function') {
                                  callback();
                              }
                          },

                          loopTimer: function() {

                              var td;
                              var d2, t2;

                              var ms = 0;
                              var s = 0;
                              var m = 0;
                              var h = 0;

                              if ($.APP.state === 'alive') {

                                  // get current date and convert it into
                                  // timestamp for calculations
                                  d2 = new Date();
                                  t2 = d2.getTime();

                                  // calculate time difference between
                                  // initial and current timestamp
                                  if ($.APP.dir === 'sw') {
                                      td = t2 - $.APP.t1;
                                      // reversed if countdown
                                  } else {
                                      td = $.APP.t1 - t2;
                                      if (td <= 0) {
                                          // if time difference is 0 end countdown
                                          $.APP.endTimer(function() {
                                              $.APP.resetTimer();
                                          });
                                      }
                                  }

                                  // calculate milliseconds
                                  ms = td % 1000;
                                  if (ms < 1) {
                                      ms = 0;
                                  } else {
                                      // calculate seconds
                                      s = (td - ms) / 1000;
                                      if (s < 1) {
                                          s = 0;
                                      } else {
                                          s = s + totalPenaltyTime;
                                          // calculate minutes
                                          var m = (s - (s % 60)) / 60;
                                          if (m < 1) {
                                              m = 0;
                                          } else {
                                              // calculate hours
                                              var h = (m - (m % 60)) / 60;
                                              if (h < 1) {
                                                  h = 0;
                                              }
                                          }
                                      }
                                  }



                                  // substract elapsed minutes & hours
                                  ms = Math.round(ms / 100);
                                  s = s - (m * 60);
                                  m = m - (h * 60);

                                  // update display
                                  $('#' + $.APP.dir + '_ms').html($.APP.formatTimer(ms));
                                  $('#' + $.APP.dir + '_s').html($.APP.formatTimer(s));
                                  $('#' + $.APP.dir + '_m').html($.APP.formatTimer(m));
                                  $('#' + $.APP.dir + '_h').html($.APP.formatTimer(h));

                                  if (totalPenaltyTime > 0) {
                                  }

                                  // loop
                                  $.APP.t = setTimeout($.APP.loopTimer, 1);

                              } else {

                                  // kill loop
                                  clearTimeout($.APP.t);
                                  return true;

                              }

                          }

                      }
                  });

              })(jQuery);
          });

      $(function () {
          $.connection.hub.url = "http://192.168.1.29:9000/signalr";

          var connection = $.hubConnection("/signalr", { useDefaultPath: false });

          var stopwatch = $.connection.StopwatchHub;

          $.connection.hub.start()
              .done(function () {
                  alert("Hub started!");
              });

          stopwatch.client.controlStopwatch = function (command) {

              if (command === 'start') {
                  $.APP.startTimer('sw');
              };

              if (command === 'stop') {
                  $.APP.stopTimer();
                  $('<form style="box-sizing: border-box;" title="Unos imena" id="forma"><input type="text" style="z-index:10000" name="name" id="inputtext"><br></form>').dialog({
                      modal: true,
                      dialogClass: "no-close",
                      buttons: {
                          'OK': function () {
                              var name = $('#inputtext').val();

                              console.log(name);

                              $(this).dialog('close');

                              var timeMs = parseInt($('#sw_ms').text()) * 10;
                              var timeS = parseInt($('#sw_s').text()) * 1000;
                              var timeM = parseInt($('#sw_m').text()) * 1000 * 60;
                              var timeH = parseInt($('#sw_h').text()) * 1000 * 60 * 60;

                              var totalTime = timeH + timeM + timeS + timeMs;

                              jQuery.ajaxSetup({ async: false });
                              $.post("http://192.168.1.29:9000/api/results",
                              { name: name, time: totalTime, crosses: [] });

                              var data = $.get("http://192.168.1.29:9000/api/results");
                              jQuery.ajaxSetup({ async: true });

                              var jsonString = data.responseJSON;

                              var jsonData = JSON.parse(jsonString);

                              $("#results").html("");

                              var trHtml = '';

                              for (var i = 0; i < jsonData.length; i++) {
                                  trHtml += '<tr><th>' + jsonData[i].Name + '</th><th>' + jsonData[i].Time + '</th></tr>';
                              };

                              $('#results').append(trHtml);

                              setTimeout(function () { location.reload(); }, 3000);
                              
                          }
                      }
                  });
              };

              if (command === 'reset') {
                  $.APP.resetTimer();
              }

              if (command === 'addTime') {
                  $.APP.addPenalty();
              }
          }
      });

  </script>

  </body>
</html>
